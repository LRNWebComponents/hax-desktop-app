<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/lrnsys-outline/lrnsys-outline.html">
<link rel="import" href="../../bower_components/map-menu/map-menu.html">
<link rel="import" href="../components/hax-app-outline-ui.html">

<dom-module id="hax-app-outline">
  <template>
    <style>
      :host {
        display: block;
      }

      :host ::content a {
        cursor: pointer;
        display: block;
        position: relative;
        padding: .2em;
      }

      :host ::content a[active="true"]:before {
        display: block;
        content: '';
        background: coral;
        color: white;
        width: 999px;
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        z-index: -1;
      }
      
      button {
        margin-right:20%; 
      }
      
    </style>
    
    <hax-app-outline-ui id="ui" outline="[[__outline.tree]]" editing="[[__outline.editing]]" active-page="[[activePge]]">
      <slot></slot>
    </hax-app-outline-ui>
    
  </template>
  <script>
    Polymer({ 
      is: 'hax-app-outline',
      properties: {
        project: {
          type: Object,
        },
        __outline: {
          type: Object,
          value: {}
        },
        addPageTarget:{
          type: Object,
          value: null,
        },
        activePage: {
          type: String,
          value: '',
        },
        __menuOpened: {
          type: Boolean,
          value: true
        },
      },

      observers: [
        '__projectChanged(project)',
        '__activePageChanged(__outline.activePage)'
      ],

      listeners: {
        'ui.edit-toggle': '__editOutlineToggle',
        'ui.save-outline': '__saveOutline',
        'ui.cancel-outline': '__cancelOutline',
        'ui.active-page-selected': '__activePageSelected'
      },

      __projectChanged: function (project) {
        if (project) {
          if (project.outlineLocation) {
            ipcRenderer.send('outline-init', this.project);
          }
        }
      },

      ready: function () {
        ipcRenderer.on('outline-updated', (e, outline) => {
          this.set('__outline', outline);
          this.notifyPath('outline.tree');
          this.notifyPath('outline.editing');
        });
        ipcRenderer.on('active-page-updated', (e, pageContents) => {
          console.log(pageContents);
        });
      },

      __activePageChanged: function (page, prevPage) {
        if (page !== prevPage) {
          if (typeof page === 'string') {
            Polymer.dom(this);
          }
        }
      },

      __editOutlineToggle: function (e) {
        ipcRenderer.send('outline-edit-toggle', this.project);
      },

      __saveOutline: function (e, outlineTree) {
        const newOutline = Object.assign(this.__outline, { tree: outlineTree });
        ipcRenderer.send('update-outline-tree', newOutline);
      },

      __cancelOutline: function (e) {
      },

      __activePageSelected: function (e, activePage) {
        ipcRenderer.send('active-page-selected', {
          outlineProjectLocation: this.__outline.projectLocation,
          activePage: activePage
        });
      }

    });
  </script>
</dom-module>
